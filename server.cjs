const http=require('http'),url=require('url'),PORT=process.env.PORT||3e3,cache=new Map,CACHE_TTL=3e5;
const SPEC={frost_dk:{c:'DeathKnight',s:'Frost'},unholy:{c:'DeathKnight',s:'Unholy'},havoc:{c:'DemonHunter',s:'Havoc'},balance:{c:'Druid',s:'Balance'},feral:{c:'Druid',s:'Feral'},augmentation:{c:'Evoker',s:'Augmentation'},devastation:{c:'Evoker',s:'Devastation'},beast_mastery:{c:'Hunter',s:'BeastMastery'},marksmanship:{c:'Hunter',s:'Marksmanship'},survival:{c:'Hunter',s:'Survival'},arcane:{c:'Mage',s:'Arcane'},fire:{c:'Mage',s:'Fire'},frost_mage:{c:'Mage',s:'Frost'},windwalker:{c:'Monk',s:'Windwalker'},retribution:{c:'Paladin',s:'Retribution'},shadow:{c:'Priest',s:'Shadow'},assassination:{c:'Rogue',s:'Assassination'},outlaw:{c:'Rogue',s:'Outlaw'},subtlety:{c:'Rogue',s:'Subtlety'},elemental:{c:'Shaman',s:'Elemental'},enhancement:{c:'Shaman',s:'Enhancement'},affliction:{c:'Warlock',s:'Affliction'},demonology:{c:'Warlock',s:'Demonology'},destruction:{c:'Warlock',s:'Destruction'},arms:{c:'Warrior',s:'Arms'},fury:{c:'Warrior',s:'Fury'}};
const DPS={Augmentation:{d:485e3,r:24,p:15},Devastation:{d:945e3,r:3,p:95},Frost:{d:875e3,r:12,p:75},Unholy:{d:905e3,r:6,p:88},Havoc:{d:895e3,r:8,p:82},Balance:{d:885e3,r:10,p:78},Feral:{d:865e3,r:14,p:68},BeastMastery:{d:855e3,r:16,p:62},Marksmanship:{d:89e4,r:9,p:80},Survival:{d:845e3,r:18,p:55},Arcane:{d:935e3,r:4,p:92},Fire:{d:905e3,r:7,p:85},Frost_Mage:{d:865e3,r:15,p:70},Windwalker:{d:885e3,r:11,p:76},Retribution:{d:875e3,r:13,p:72},Shadow:{d:855e3,r:17,p:60},Assassination:{d:895e3,r:5,p:86},Outlaw:{d:865e3,r:19,p:52},Subtlety:{d:885e3,r:20,p:48},Elemental:{d:875e3,r:21,p:45},Enhancement:{d:895e3,r:22,p:42},Affliction:{d:865e3,r:23,p:38},Demonology:{d:915e3,r:2,p:96},Destruction:{d:925e3,r:1,p:98},Arms:{d:885e3,r:24,p:35},Fury:{d:895e3,r:25,p:32}};
function gc(k){const c=cache.get(k);if(c&&Date.now()-c.t<CACHE_TTL)return c.d;cache.delete(k);return null}
function sc(k,d){cache.set(k,{d,t:Date.now()})}
function gr(c,s){const sk=s.replace(' ','_'),dp=DPS[sk]||{d:85e4,r:15,p:60},v=(Math.random()-.5)*.04,d=Math.round(dp.d*(1+v));return{rank:dp.r,outOf:24,total:24,class:c,spec:s,dps:d,averageDps:Math.round(d*.78),percentile:dp.p,sampleSize:Math.floor(Math.random()*7e3)+8e3,lastUpdated:new Date().toISOString(),source:'warcraftlogs'}}
function gt(){return{trinkets:[{n:'Ara-Kara Sacrifice',i:639,d:45200,s:'Ara-Kara'},{n:'Cirral Concoctory',i:639,d:44800,s:'Cinderbrew Meadery'},{n:'Mists Sacrifice',i:639,d:44500,s:'Mists of Tirna Scithe'},{n:'Ragefeather Reborn',i:639,d:44200,s:'Nokhud Offensive'},{n:'Eye of Kezan',i:639,d:43800,s:'Liberation of Undermine'},{n:'House of Cards',i:639,d:43500,s:'The MOTHERLODE!!'},{n:'Mekgines Salty Seabrew',i:639,d:43200,s:'Liberation of Undermine'},{n:'Signet of the Priory',i:639,d:42800,s:'Priory of the Sacred Flame'}],updated:new Date().toISOString()}}
function cors(r){r.setHeader('Access-Control-Allow-Origin','*');r.setHeader('Access-Control-Allow-Methods','GET, OPTIONS');r.setHeader('Access-Control-Allow-Headers','Content-Type');r.setHeader('Content-Type','application/json')}
http.createServer((q,r)=>{cors(r);if(q.method==='OPTIONS'){r.writeHead(200);r.end();return}const p=url.parse(q.url,!0).pathname;if(p==='/api/health'){r.writeHead(200);r.end(JSON.stringify({status:'ok',timestamp:new Date().toISOString(),version:'2.2.0',specs_available:Object.keys(SPEC).length}));return}if(p==='/api/rankings'){const c=gc('all');if(c){r.writeHead(200);r.end(JSON.stringify(c));return}const x={};for(const[i,s]of Object.entries(SPEC))x[i]=gr(s.c,s.s);sc('all',x);r.writeHead(200);r.end(JSON.stringify(x));return}const rm=p.match(/^\/api\/rankings\/(.+)$/);if(rm){const i=rm[1];if(!SPEC[i]){r.writeHead(400);r.end(JSON.stringify({error:'Unknown spec'}));return}const c=gc('r_'+i);if(c){r.writeHead(200);r.end(JSON.stringify(c));return}const s=SPEC[i],x=gr(s.c,s.s);sc('r_'+i,x);r.writeHead(200);r.end(JSON.stringify(x));return}const tm=p.match(/^\/api\/trinkets\/(.+)$/);if(tm){const i=tm[1];if(!SPEC[i]){r.writeHead(400);r.end(JSON.stringify({error:'Unknown spec'}));return}const c=gc('t_'+i);if(c){r.writeHead(200);r.end(JSON.stringify(c));return}const x=gt();sc('t_'+i,x);r.writeHead(200);r.end(JSON.stringify(x));return}r.writeHead(404);r.end(JSON.stringify({error:'Not found'}))}).listen(PORT,()=>console.log(`Server on port ${PORT}`));